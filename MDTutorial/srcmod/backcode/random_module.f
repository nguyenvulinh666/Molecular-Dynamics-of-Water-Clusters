        MODULE random_module
        use error_module
        IMPLICIT NONE
        integer, parameter :: mm=34, nn=69, rr=5, ww=32
        integer, parameter :: wmask=-1, umask=-32, lmask=31
        integer, parameter :: shift0=12, shift1=18, shiftb=7, shiftc=15
        integer, parameter :: nmtg=256
        integer, parameter :: alist(0:nmtg-1)=
     x     (/ 
     x             -82509824,   -515375103,  -1457979390,   -875495421, 
     x           -1095172092,  -1125711867,  -1769209850,  -1606418425, 
     x            -345505784,  -1850998775,  -1437007862,  -2006056949, 
     x            -332726260,  -2084438003,  -2080112626,    -40894449, 
     x            -124846064,   -734724079,  -2078474222,  -1030684653, 
     x           -1295450092,  -2109538283,   -550043626,   -695009257, 
     x            -616562664,   -484638695,   -492109798,  -1603928037, 
     x            -367460324,  -1728708579,  -2086862818,  -1667366881, 
     x           -2140274656,   -861732831,   -892010462,  -1632174045, 
     x           -1732444124,  -1141178331,  -1106247642,   -193396697, 
     x             -58720216,  -1857355735,   -326893526,  -1679491029, 
     x            -788987860,   -339804115,  -1519255506,  -1498611665, 
     x           -1227685840,  -1494089679,   -969932750,    -21299149, 
     x           -1301151692,   -837353419,  -1424555978,   -909836233, 
     x           -1388707784,   -126943175,   -488898502,   -356253637, 
     x             -17563588,    -97779651,  -2088763330,   -916520897, 
     x           -1025114048,  -1518403519,  -1221394366,  -1033306045, 
     x           -1259863996,   -443285435,    -77397946,   -663355321, 
     x            -730070968,    -94896055,  -1926365110,   -670826421, 
     x           -1005125556,   -380239795,  -1036058546,   -884342705, 
     x            -564264880,  -1731461039,    -81723310,   -332791725, 
     x           -1142095788,  -1692401579,  -1154547626,  -1736114089, 
     x            -367984552,   -142213031,    -42336166,   -661389221, 
     x           -1269759908,  -1050476451,  -1332150178,   -414711713, 
     x           -2050424736,   -618528671,   -408682398,  -1775501213, 
     x           -1084555164,  -2059861915,  -1535704986,  -1278214041, 
     x            -102301592,  -1533018007,  -1353121686,   -216792981, 
     x            -112000916,   -438632339,   -492306322,    -49282961, 
     x           -1422589840,  -1257111439,  -2008874894,  -1369636749, 
     x           -1726152588,   -337051531,  -1093664650,   -333774729, 
     x            -682360712,   -194510727,   -227737478,   -537526149, 
     x             -21036932,  -1704001411,   -351403906,   -912785281, 
     x            -468647808,   -108068735,   -643104638,  -1162674045, 
     x           -1113980796,   -735313787,   -314507130,   -863502201, 
     x            -998309752,   -209911671,   -212664182,    -75628405, 
     x           -1149894516,   -380108659,   -645332850,  -1386151793, 
     x            -207290224,  -1263337327,   -251133806,   -392888173, 
     x           -1080819564,   -275578731,    -76545898,   -286719849, 
     x           -1352204136,  -1742339943,   -114425702,   -779288421, 
     x             -65273700,  -2009136995,   -943062882,  -1976172385, 
     x           -1734999904,   -774504287,  -1052573534,   -572784477, 
     x              -5570396,   -185073499,  -1425735514,   -406126425, 
     x           -1097465688,  -1435303767,   -935591766,  -1777729365, 
     x            -878182228,  -1914830675,  -1926627154,   -618594129, 
     x           -1625816912,   -628490063,   -589758286,  -1232469837, 
     x           -1024458572,   -888799051,  -1414594378,  -1484717897, 
     x           -1202061128,   -828964679,  -1131413318,     -5242693, 
     x           -1927479108,   -194707267,  -2006056770,   -163970881, 
     x            -569311040,  -2000486207,  -1839071038,    -94568253, 
     x            -998375228,  -1952513851,   -632028986,   -676462393, 
     x            -572587832,   -538509111,  -1341325110,  -1858862901, 
     x            -728760116,  -1353449267,   -970194738,   -974847793, 
     x           -1125252912,  -1430126383,   -301661998,  -1528233773, 
     x           -1565720364,   -208994091,  -1687748394,  -1821376297, 
     x           -1873149736,  -1116012327,   -764149542,     -3669797, 
     x           -2045181732,  -1206189859,  -1875443490,  -1585839905, 
     x           -1900019488,   -566165279,    -70582046,  -1331822365, 
     x            -987889436,   -891879195,   -738983706,  -1273167641, 
     x           -1707474712,   -412286743,   -109182742,   -456261397, 
     x           -1748696852,   -460521235,   -932839186,  -1990655761, 
     x           -1490222864,   -181206799,  -1234960142,  -1933049613, 
     x           -1556479756,  -1625751307,  -1256062730,  -1564475145, 
     x           -1491468040,  -2047016711,  -2118844166,   -965082885, 
     x           -1680080644,   -405274371,  -1176698626,  -1943600897
     x           /)

        integer, parameter :: mblist(0:nmtg-1)=
     x     (/ 
     x             918484608,    716666752,   1922400128,   -984171648, 
     x           -1318422656,    681897856,   1655601024,   -458690688, 
     x            -847806592,  -1301483648,  -1653707136,   -650806400, 
     x            1020616448,    630683520,   1722122112,  -1116410112, 
     x            -303073664,   -847986816,  -1690976896,   -579019392, 
     x           -1645381760,    590018176,   1154903680,    896892800, 
     x            -848855168,  -1034096768,  -1177199744,  -1417906432, 
     x            -680169600,  -1650364800,  -1150001792,    996503424, 
     x            -690686080,  -1296113792,   -419996032,  -1695910016, 
     x            -713626240,    712470400,   1926918016,    899381120, 
     x            -579012736,   -581470336,  -1385465984,  -1381187712, 
     x            -894111872,  -1143181696,    749567872,  -1654163584, 
     x           -1112688768,   1836416896,   -353011968,    682946432, 
     x             624228096,    844562176,  -1128632704,  -1162944640, 
     x            1840609152,   1722646400,   -713757312,  -1145278848, 
     x           -1765970048,   1991605120,   -825051392,  -1665508480, 
     x            -824594688,    883783296,   -311050368,   -579373184, 
     x           -1720486016,   1509062272,   1654550144,   -430612736, 
     x             664731264,  -1502808192,   1968600960,   -143278720, 
     x           -1451823232,   -852263040,    626882432,    897546112, 
     x            2069217024,    978673536,   -723028096,   -344760960, 
     x           -1498646656,   1721071488,    836173696,   1918267264, 
     x            -579412096,   -427102336,  -1160450176,  -1649058176, 
     x             913667968,    917960448,   -591732864,    716664704, 
     x            -843780480,   -961970304,   -574263424,   -814825600, 
     x             647329664,   -995557504,   -321620608,   -749277312, 
     x             717152128,   -592126080,   1903588992,   1722120064, 
     x            1705867136,   -846793088,  -1177133440,  -1563134080, 
     x            1834073856,   -860037248,  -1725270144,   1512863616, 
     x             595259264,   1924560768,   1719500672,   1971158912, 
     x           -1251149952,   -849903872,    619542272,    651622016, 
     x            2002089856,  -1688834432,  -1687175296,   -572952704, 
     x            1718187904,   -648317056,   1726576512,  -1720420480, 
     x             649426816,   1505130112,  -1490225280,   -422224000, 
     x            -760418432,   -848461952,    712830592,  -1225408640, 
     x             586086272,   -613582976,   -847841408,    913766144, 
     x            -915081344,   -574824832,   1972268672,  -1147216256, 
     x            1789753216,   1923446656,    987950976,    586119040, 
     x            -894075008,   1722120064,   1697609600,   1701672832, 
     x            -843793024,  -1787531648,   -848896128,    729083776, 
     x            -315900032,  -1177045120,   -227250816,   1442213504, 
     x             963833728,   1723168640,  -1699391616,    582317952, 
     x           -1487474944,   -579897472,    922154880,   -647694464, 
     x            1991604096,    628457344,  -1162416512,    645234560, 
     x            -828055680,   -714281600,   -847939712,   -604709504, 
     x            -676008576,   1432252288,   1926586240,  -1704167552, 
     x            -848330880,   -709398656,  -1498613888,   -581640320, 
     x            -749277312,  -1699451008,  -1519585408,   -355174656, 
     x            -915081344,    729476992,   -589990144,  -1385891968, 
     x           -1432062080,    578254720,   -355108992,    649002880, 
     x             847705728,   -304779648,  -1684640128,    728035200, 
     x            -278020224,   -713760896,  -1722059008,  -1655349504, 
     x             628946816,   -826966144,   -850043008,    896497536, 
     x           -1116279040,  -1486192768,   -933791872,    897021824, 
     x            1991606144,   -848855168,   1685747328,   -592742528, 
     x            -360876288,  -1393201280,  -1696303488,    733147008, 
     x           -1452611712,   -893978752,   1730770816,    635893376, 
     x           -1229654144,   1924366208,  -1502707840,   -848330880, 
     x            -982861952,  -1152065664,  -1118374144,  -1666419840, 
     x            -647268480,  -1703053440,  -1163595904,   -622889088, 
     x           -1653098624,   1789884288,   -856195200,   1442213504, 
     x           -1302007936,  -1519583360,   -848855168,    913766272, 
     x            -594184320,    715487104,   -365666944,  -1655343232, 
     x            -843614336,  -1672127104,   1916172032,   -302614656
     x            /)

        integer, parameter :: mclist(0:nmtg-1)=
     x     (/ 
     x            -271253504,   -135430144,   -404258816,   -134905856, 
     x            -271745024,   -286818304,   -268763136,   -538607616, 
     x            -338558976,   -269189120,   2077556736,   2010480640, 
     x            -134905856,   -272465920,   -338329600,   -287932416, 
     x            -539295744,   -135921664,   2012053504,   -135430144, 
     x            2010742784,   -269910016,   -272269312,   -404258816, 
     x            -338329600,   -269058048,   2002190336,   -137003008, 
     x            2074968064,   1875181568,   -137003008,   -272269312, 
     x            -275283968,   -137035776,   2077589504,   1866563584, 
     x            -270237696,   -288194560,   -274759680,   -271417344, 
     x            -270565376,   -277020672,   2009694208,   2071396352, 
     x            -270204928,   -273317888,   -411238400,   2010611712, 
     x            2001829888,   -136019968,   2010611712,   -286818304, 
     x            -271089664,   -336232448,   -271089664,   -138117120, 
     x            -137003008,   -338853888,   -271220736,   -275415040, 
     x            2077589504,   -271220736,   -136347648,   -135888896, 
     x            2077589504,   -271745024,   2010611712,   -269123584, 
     x            2010611712,   -136478720,   -271253504,   2077589504, 
     x            -336265216,   -271876096,   -272302080,   2077720576, 
     x            -270041088,   -405438464,   -271155200,   -269647872, 
     x            -134971392,   -136871936,   -135102464,   2010415104, 
     x            -271876096,   -270172160,   -342523904,   -271253504, 
     x            -135823360,   -604078080,   -275415040,   2010480640, 
     x            -271384576,   -271286272,   -135495680,   -271089664, 
     x            -271220736,   -338821120,   -279117824,   2076934144, 
     x            -271155200,   -201523200,   2011791360,   -268632064, 
     x            -145391616,   -135823360,   -268632064,   -271089664, 
     x            -134971392,   -269549568,   2011922432,   -270761984, 
     x            -136937472,   -136904704,   -137035776,   -271941632, 
     x            -287997952,   -270106624,   -338198528,   -269123584, 
     x            -272334848,   -336363520,   -137003008,   -270204928, 
     x            -270172160,   -271286272,   1995276288,   2075492352, 
     x            -272302080,   -287932416,   -272302080,   -269516800, 
     x            -271220736,   -271351808,   -271745024,   2073526272, 
     x            -272269312,   -405438464,   -271253504,   2077687808, 
     x            -277512192,   -288653312,   -270106624,   -271351808, 
     x            -271220736,   -135954432,   -271253504,   -135954432, 
     x            -135757824,   -271089664,   -279609344,   -277118976, 
     x            -404324352,   -137265152,   -271908864,   -270237696, 
     x            2010415104,   -271286272,   -137396224,   -286818304, 
     x            2011660288,   2006745088,   1876262912,   -271220736, 
     x            -271220736,   -271220736,   2011922432,   -273186816, 
     x            -556433408,   -271220736,   -279609344,   -271122432, 
     x            -270204928,   -337149952,   -271220736,   -203456512, 
     x            -135725056,   -270172160,   -287637504,   -137035776, 
     x            -270172160,   -271876096,   -146341888,   -272302080, 
     x            -338886656,   -287932416,   -272138240,   -137428992, 
     x            -269156352,   -271089664,   -269647872,   2011922432, 
     x            -271089664,   -286687232,   -271089664,   -137789440, 
     x            -135692288,   -272924672,   2007531520,   -336232448, 
     x            -269811712,   2077065216,   -271253504,   -286294016, 
     x            2079686656,   -137035776,   2010480640,   2077589504, 
     x            -269778944,   -338427904,   2006417408,   -271745024, 
     x            -271417344,   -338100224,   -279642112,   -271351808, 
     x            -404422656,   -339050496,   -271515648,   -134545408, 
     x            2010480640,   2077589504,   2010480640,   -286818304, 
     x            -268599296,   -271319040,   -269647872,   -271253504, 
     x            -271253504,   -405340160,   -270827520,   -338722816, 
     x            2012708864,   -137068544,   -270630912,   -268599296, 
     x            -272302080,   2010873856,   -272269312,   2008317952, 
     x            2010447872,   -402948096,   -338362368,   -271220736, 
     x            -268992512,   -202014720,   -338362368,   -271089664, 
     x            -268664832,   -135626752,   2012053504,   1878458368, 
     x            -269877248,   2010447872,   -271155200,   2002092032
     x     /)
        integer, save :: aaa
        integer, save :: maskb, maskc
        integer, save :: mti=nn+1
        integer, save :: state(0:nn-1)  
        public :: init_genrand, grnd, mt_dump_status, mt_read_status
        contains
       
        subroutine mt_dump_status(inode, mnodes)
          IMPLICIT NONE
          integer, intent(in) :: inode, mnodes
          integer :: buf((nn+1)*mnodes), gbuf((nn+1)*mnodes), i, j
          integer :: ierror

          buf=0
          j=inode*(nn+1)+1
          buf(j)=mti
          do i=0,nn-1
            j=j+1
            buf(j)=state(i)
          end do
          gbuf=buf
          call gisum_on_root(buf,(nn+1)*mnodes,gbuf)
          if (inode.eq.0) then
            open(911,file='REVPRNG')
            write(911,*) mnodes
            write(911,*) gbuf
            close(911)
          endif
        end subroutine

        subroutine mt_read_status(inode, mnodes)
          use setup_module
          IMPLICIT NONE
          integer, intent(in) :: inode, mnodes
          integer :: buf((nn+1)), gbuf((nn+1)*mnodes)
          integer :: ierror, rnodes, i 
          open(911,file='REVPRNG',status='OLD',iostat=ierror)
          rnodes=0
          if (ierror.eq.0) then
            if (inode.eq.0) then
              write(nrite,*) 
     x          " Reading restart file for PRNG."
              read(911,*) rnodes
            end if
            call gisum(rnodes,1,buf)
            if (rnodes.ne.mnodes) call error(inode,3011)
            if (inode.eq.0) then
              read(911,*) gbuf
            endif

          else
            return
          endif
          close(911)

          call giscat(gbuf,nn+1,buf)
          mti=buf(1)
          do i=0,nn-1
            state(i)=buf(i+2)
          enddo
          return
        end subroutine

        subroutine init_genrand(seed, istream)
          integer, intent(in) :: seed, istream
          integer :: buff
          buff=seed+istream
          do mti=0,nn-1
            state(mti)=buff
            buff=IEOR(buff, ISHFT(buff,-30))
            buff=buff*1812433253+mti+1
          enddo
          mti=nn
          if (istream.ge.nmtg) call error(0,3010)
          aaa=alist(istream)
          maskb=mblist(istream)
          maskc=mclist(istream)
          return
        end subroutine init_genrand

	 double precision function grnd()
          integer :: x, k, n, m, lim
          integer, save :: zeroa(0:1)= (/ 0, 0 /) !zeroa(x) <-> ( x ? a : 0 )
          zeroa(1)=aaa
          
          if (mti.ge.nn) then
            n=nn
            m=mm
            lim=n-m-1
            do k=0, lim
              x=IOR(IAND(state(k),umask), IAND(state(k+1),lmask))
              state(k)=IEOR(IEOR(state(k+m),
     x                  ISHFT(x,-1)),zeroa(IAND(x,1)))
            enddo
            lim=n-2
            do k=n-m,lim
              x=IOR(IAND(state(k),umask), IAND(state(k+1),lmask))
              state(k)=IEOR(IEOR(state(k+m-n),
     x                  ISHFT(x,-1)),zeroa(IAND(x,1)))
            enddo
            x=IOR(IAND(state(n-1),umask),IAND(state(0),lmask))
            state(n-1)=IEOR(IEOR(state(m-1), 
     x                  ISHFT(x,-1)),zeroa(IAND(x,1)))
            mti=0
          endif
          
          x = state(mti)
          mti = mti + 1  
          x=IEOR(x,ISHFT(x,-shift0))
          x=IEOR(x,IAND(ISHFT(x,shiftb),maskb))
          x=IEOR(x,IAND(ISHFT(x,shiftc),maskc))
          x=IEOR(x,ISHFT(x,-shift1))       
          if (x<-0) then
            grnd=(dble(x) + 2.0D0**32)/(2.0D0**32 - 1.0D0)
          else
            grnd=dble(x)/(2.0D0**32 - 1.0D0)
          endif
          return
        end function grnd

       ENDMODULE random_module
